package net.openreview.model
package mongodb

import java.util.UUID
import java.util.{Date}
import com.novus.salat._
import com.novus.salat.dao._
import com.novus.salat.annotations._
import com.mongodb.casbah.Imports._
import se.radley.plugin.salat._
import com.novus.salat.global._

import com.mongodb.casbah.commons.conversions._
import com.mongodb.casbah.commons.conversions.scala._
import org.bson.{ BSON, Transformer }
import java.net.{URL, URLEncoder}

object RegisterURLHelpers extends URLSerializer with URLDeserializer {
  def apply() = {
    log.debug("Registering URL Serializers.")
    super.register()
  }
}


trait URLSerializer extends MongoConversionHelper {

  private val encodeType = classOf[URL]
  /** Encoding hook for MongoDB To be able to persist URL to MongoDB */
  private val transformer = new Transformer {

    def transform(o: AnyRef): AnyRef = {
      log.trace("Encoding a java.net.URL")
      o match {
        // TODO: There has to be a better way to marshall a URL than string munging like this...
        case url: java.net.URL => "URL~%s".format(url.toExternalForm)
        case _ => o
      }
    }
  }

  override def register() = {
    log.debug("Hooking up java.net.URL serializer.")
    BSON.addEncodingHook(encodeType, transformer)
    super.register()
  }

  override def unregister() = {
    log.debug("De-registering java.net.URL serializer.")
    BSON.removeEncodingHooks(encodeType)
    super.unregister()
  }
}

trait URLDeserializer extends MongoConversionHelper {
  private val encodeType = classOf[String]
  private val transformer = new Transformer {

    def transform(o: AnyRef): AnyRef = {
      log.trace("Decoding java.net.URL")
      o match {
        case s: String if s.startsWith("URL~") && s.split("~").size == 2 => {
          log.info("DECODING: %s", s)
          new java.net.URL(s.split("~")(1))
        }
        case _ => o
      }
    }
  }

  override def register() = {
    log.debug("Hooking up java.net.URL deserializer")

    BSON.addDecodingHook(encodeType, transformer)
    super.register()
  }

  override def unregister() = {
    log.debug("De-registering java.net.URL  deserializer.")
    BSON.removeDecodingHooks(encodeType)
    super.unregister()
  }
}
